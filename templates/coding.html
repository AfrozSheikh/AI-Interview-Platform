{% extends "base.html" %}

{% block title %}Coding Test{% endblock %}

{% block head %}
<style>
    .code-editor {
        font-family: 'Courier New', monospace;
        tab-size: 4;
    }
    .test-case {
        transition: all 0.3s;
    }
    .test-case.passed {
        background-color: #d1fae5;
        border-color: #10b981;
    }
    .test-case.failed {
        background-color: #fee2e2;
        border-color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-xl p-6 mb-6 shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold">
                    <i class="fas fa-code mr-2"></i> Coding Challenge
                </h2>
                <p class="opacity-90">Test your programming skills with AI evaluation</p>
            </div>
            <div class="text-right">
                <div id="coding-timer" class="text-xl font-bold">10:00</div>
                <div class="text-sm">Python Only</div>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Problem Statement -->
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-file-alt mr-2 text-blue-600"></i> Problem Statement
                </h3>
                <div class="prose max-w-none">
                    <div class="p-4 bg-gray-50 rounded-lg mb-4">
                        <h4 class="font-bold text-gray-700 mb-2">Problem:</h4>
                        <p id="problem-statement" class="text-gray-800">
                            {{ problem.problem_statement }}
                        </p>
                    </div>
                    
                    <div class="p-4 bg-blue-50 rounded-lg mb-4">
                        <h4 class="font-bold text-blue-700 mb-2">Example:</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600">Input:</p>
                                <code class="block p-2 bg-white rounded">{{ problem.example_input }}</code>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Output:</p>
                                <code class="block p-2 bg-white rounded">{{ problem.example_output }}</code>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-yellow-50 rounded-lg mb-4">
                        <h4 class="font-bold text-yellow-700 mb-2">Constraints:</h4>
                        <p id="problem-constraints" class="text-gray-800">
                            {{ problem.constraints }}
                        </p>
                    </div>
                    
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h4 class="font-bold text-green-700 mb-2">Hints:</h4>
                        <p id="problem-hints" class="text-gray-800">
                            {{ problem.hints }}
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Test Cases -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-vial mr-2 text-purple-600"></i> Test Cases
                </h3>
                <div id="test-cases-container" class="space-y-3">
                    <!-- Test cases will be loaded here -->
                    <div class="test-case p-3 border rounded-lg">
                        <div class="flex justify-between items-center">
                            <div>
                                <span class="font-medium">Test Case 1</span>
                                <span class="ml-2 text-sm text-gray-500">Sample test</span>
                            </div>
                            <span class="text-gray-400">Not run</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Code Editor -->
        <div class="space-y-6">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-edit mr-2 text-green-600"></i> Code Editor
                    </h3>
                    <div class="flex space-x-2">
                        <button id="run-code" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center">
                            <i class="fas fa-play mr-2"></i> Run Code
                        </button>
                        <button id="reset-code" 
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                            Reset
                        </button>
                    </div>
                </div>
                
                <div class="mb-4">
                    <textarea id="code-editor" rows="20" 
                              class="code-editor w-full p-4 border rounded-lg font-mono text-sm bg-gray-900 text-white">
def solve_problem():
    # Write your solution here
    # Remove this comment and implement your solution
    
    # Example: Find maximum in a list
    # def find_max(numbers):
    #     return max(numbers) if numbers else None
    
    pass

# Test your function
if __name__ == "__main__":
    # Add your test cases here
    print("Solution ready!")
                    </textarea>
                </div>
                
                <div class="text-sm text-gray-500 mb-6">
                    <i class="fas fa-info-circle mr-1"></i> 
                    Write your solution in the function above. The code will be executed in a secure sandbox.
                </div>
                
                <!-- Execution Output -->
                <div class="mb-6">
                    <h4 class="font-bold mb-2 flex items-center">
                        <i class="fas fa-terminal mr-2 text-yellow-600"></i> Output
                    </h4>
                    <div id="code-output" class="p-4 bg-gray-900 text-white rounded-lg font-mono text-sm min-h-[100px]">
                        Output will appear here...
                    </div>
                </div>
                
                <!-- Submit Button -->
                <div class="text-center">
                    <button id="submit-code" 
                            class="px-8 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg font-semibold hover:opacity-90 text-lg">
                        <i class="fas fa-paper-plane mr-2"></i> Submit for AI Evaluation
                    </button>
                </div>
            </div>
            
            <!-- AI Evaluation (Initially Hidden) -->
            <div id="ai-evaluation" class="bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-robot mr-2 text-purple-600"></i> AI Evaluation
                </h3>
                <div id="evaluation-content" class="space-y-4">
                    <!-- Evaluation will be loaded here -->
                </div>
                <div class="mt-6 text-center">
                    <a href="{{ url_for('feedback') }}" 
                       class="px-6 py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg font-semibold hover:opacity-90">
                        Continue to Feedback <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/interview.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const codeEditor = document.getElementById('code-editor');
    const runButton = document.getElementById('run-code');
    const submitButton = document.getElementById('submit-code');
    const resetButton = document.getElementById('reset-code');
    const outputDiv = document.getElementById('code-output');
    const evaluationDiv = document.getElementById('ai-evaluation');
    const evaluationContent = document.getElementById('evaluation-content');
    
    // Timer for coding test
    let timeLeft = 600; // 10 minutes
    const timerDisplay = document.getElementById('coding-timer');
    
    const timerInterval = setInterval(() => {
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert('Time is up!');
            return;
        }
        
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
    
    // Run code locally
    runButton.addEventListener('click', async () => {
        const code = codeEditor.value;
        outputDiv.textContent = 'Running code...';
        
        const response = await fetch('/api/evaluate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, preview: true })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            if (data.execution.output) {
                outputDiv.textContent = data.execution.output;
            } else if (data.execution.error) {
                outputDiv.textContent = 'Error: ' + data.execution.error;
            }
        } else {
            outputDiv.textContent = 'Error: ' + data.message;
        }
    });
    
    // Submit code for AI evaluation
    submitButton.addEventListener('click', async () => {
        const code = codeEditor.value;
        const timeTaken = 600 - timeLeft;
        
        outputDiv.textContent = 'Submitting for AI evaluation...';
        
        const response = await fetch('/api/evaluate-code', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                code: code, 
                time_taken: timeTaken,
                preview: false 
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Show evaluation
            const evalData = data.evaluation;
            
            evaluationContent.innerHTML = `
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="text-center p-4 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-700">${evalData.logic_score}/10</div>
                        <div class="text-sm text-blue-600">Logic</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-700">${evalData.efficiency_score}/10</div>
                        <div class="text-sm text-green-600">Efficiency</div>
                    </div>
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-700">${evalData.clarity_score}/10</div>
                        <div class="text-sm text-purple-600">Clarity</div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">Test Results:</h4>
                    <p>${evalData.test_cases_passed}/${evalData.total_test_cases} test cases passed</p>
                </div>
                
                <div class="p-4 bg-yellow-50 rounded-lg mb-4">
                    <h4 class="font-bold mb-2">Complexity Analysis:</h4>
                    <p>Time: ${evalData.time_complexity || 'N/A'}, Space: ${evalData.space_complexity || 'N/A'}</p>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg">
                    <h4 class="font-bold mb-2">Feedback:</h4>
                    <p>${evalData.detailed_feedback || 'No feedback available.'}</p>
                </div>
            `;
            
            evaluationDiv.classList.remove('hidden');
            clearInterval(timerInterval);
        } else {
            outputDiv.textContent = 'Submission failed: ' + data.message;
        }
    });
    
    // Reset code
    resetButton.addEventListener('click', () => {
        if (confirm('Reset code to default?')) {
            codeEditor.value = `def solve_problem():
    # Write your solution here
    # Remove this comment and implement your solution
    
    # Example: Find maximum in a list
    # def find_max(numbers):
    #     return max(numbers) if numbers else None
    
    pass

# Test your function
if __name__ == "__main__":
    # Add your test cases here
    print("Solution ready!")`;
            outputDiv.textContent = 'Output will appear here...';
        }
    });
});
</script>
{% endblock %}